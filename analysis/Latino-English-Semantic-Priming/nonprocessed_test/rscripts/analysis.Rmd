---
title: "Latino English Semantic Priming"
output:
  rmarkdown::github_document
  # pdf_document: default
  # html_document:
  #   df_print: paged
  
  
  #EVENTUALLY I'M GOING TO HAVE TO EXCLUDE THE ENGLISH L2 SPEAKERS FROM GRAPHS
---

```{r message=FALSE, warning=FALSE, include=FALSE}
#Loading everything
library(tidyverse)
# library(lme4)
# library(lmerTest)
source("helpers.R")

#removes gray boxes from plots
theme_set(theme_bw())

# color-blind-friendly palette
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") 

# load the main data
d = read_csv("../data/nonprocessed_test-trials.csv") 
# load information about contextual features and merge into dataset
subject_info = read_csv("../data/nonprocessed_test-subject_information.csv")

d = d %>%
  mutate(id = row_number())
```

## Exclusions
### Native Language  
Excluding English L2
```{r echo=FALSE, message=FALSE, warning=FALSE}
lang_exclude = subject_info %>% 
  select(workerid, first_language) %>% 
  filter(str_detect(first_language,regex("english", ignore_case=TRUE),negate=TRUE)) %>%
  select(workerid, first_language) 
lang_exclude
#d = d[!(d$workerid %in% lang_exclude$workerid),]
```

### Accuracy 
Excluding participants with accuracy rates lower than 90%
```{r echo=FALSE, message=FALSE, warning=FALSE}
accuracy_d = d %>%
  filter(Trial_Type == "critical") %>%
  mutate(correct=ifelse(Response==Target_Word_Type,1,0)) %>% 
  group_by(workerid) %>%
  summarise(Mean=mean(correct),CILow=ci.low(correct),CIHigh=ci.high(correct)) %>%
  ungroup() %>%
  mutate(YMin=Mean-CILow,YMax=Mean+CIHigh) %>%
  mutate(Participant_Accuracy=ifelse(Mean<0.90,"Participants with Low Accuracy - Excluded","Participants with High Accuracy - Included"))
#View(accuracy_d)

h=0.90
ggplot(accuracy_d, aes(x=reorder(workerid,Mean), y=Mean, fill=Participant_Accuracy)) +
  geom_bar(stat="identity") +
  geom_hline(yintercept=h) +
  geom_text(aes(0, h, label=h, vjust=-1, hjust=-0.3)) +
  scale_fill_manual(values = cbPalette) +
  xlab("Worker ID") +
  theme(legend.title = element_blank())

exclude = accuracy_d %>%
  filter(Participant_Accuracy==1)
#exclude
#d = d[!(d$workerid %in% exclude$workerid),]
```

### Duration
Excluding participants who take more than 2.5 SDs from mean completion time
```{r echo=FALSE, message=FALSE, warning=FALSE}
exp_time_d = d %>%
  mutate(Mean=mean(Answer.time_in_minutes),SD=sd(Answer.time_in_minutes)) %>%
  mutate(Ulimit=Mean+2.5*SD,Llimit=Mean-2.5*SD) %>%
  mutate(slow=ifelse(Answer.time_in_minutes>Ulimit,"1","0")) %>%
  mutate(fast=ifelse(Answer.time_in_minutes<Llimit,"1","0")) %>%
  select(workerid,id,Answer.time_in_minutes,slow,fast,Mean,SD,Llimit,Ulimit) %>%
  filter(slow==1 | fast == 1)
exp_time_d
#View(exp_time_d)
#d = d[!(d$workerid %in% exp_time_d$workerid),]
```

### Individual Responses
Excluding individual responses that are faster than 500ms or more than 3 SDs from mean RT

```{r echo=FALSE, message=FALSE, warning=FALSE}
d_trials = d %>%
  filter(!is.na(Trial_Type))
exclude_sd = d_trials %>%
  mutate(Mean=mean(Response_Time),SD=sd(Response_Time),count=n()) %>%
  mutate(Ulimit=Mean+3*SD,Llimit=Mean-3*SD) %>%
  mutate(slow=ifelse(Response_Time>Ulimit,"1","0")) %>%
  mutate(fast=ifelse(Response_Time<Llimit,"1","0")) %>%
  # excludes individual responses <500ms
  mutate(toofast=ifelse(Response_Time<500, "1", "0")) %>%
  select(workerid,id,Response_Time,slow,fast,toofast,Mean,SD,Llimit,Ulimit) %>%
  filter(slow==1 | fast == 1 | toofast == 1)
exclude_sd
#View(exclude_sd)
#d = d[!(d$id %in% exclude_sd$id),]
#View(d)
```

## Plots
### Raw RT Histogram
```{r echo=FALSE, message=FALSE, warning=FALSE}
d %>%
  filter(Trial_Type == "control" | Trial_Type == "critical") %>%
  mutate(talker_condition = ifelse(List=='1_GE' | List == '2_GE','GE','Other')) %>%
  group_by(talker_condition, Trial_Type) %>%
  ggplot(aes(x=Response_Time,fill=talker_condition)) +
  geom_density(alpha=.5) +
  xlab("Raw RT") +
  ylab("Density")
```

### Log Transformed RT Histogram
```{r echo=FALSE, message=FALSE, warning=FALSE}
d %>%
  filter(Trial_Type == "control" | Trial_Type == "critical") %>%
  mutate(talker_condition = ifelse(List=='1_GE' | List == '2_GE','GE','Other')) %>%
  group_by(talker_condition, Trial_Type) %>%
  ggplot(aes(x=log(Response_Time),fill=talker_condition)) +
  geom_density(alpha=.5) +
  xlab("Log Transformed RT") +
  ylab("Density")
```

### All Conditions RT Bar Plot
```{r echo=FALSE, message=FALSE, warning=FALSE}
d %>%
  filter(Trial_Type == "control" | Trial_Type == "critical") %>%
  mutate(Trial_Type = fct_recode(Trial_Type, "Semantically Unrelated Target" = "control", "Semantically Related Target" = "critical")) %>%
  group_by(Trial_Type) %>%
  summarize(MeanRT = mean(Response_Time), CI.Low = ci.low(Response_Time), CI.High = ci.high(Response_Time)) %>%
  mutate(YMin = MeanRT - CI.Low, YMax = MeanRT + CI.High) %>%
  ggplot(aes(x =Trial_Type, y=MeanRT, fill = Trial_Type)) +
  geom_bar(stat="identity")  +
  xlab("Prime Condition") +
  ylab("Mean RT (ms)") +
  scale_fill_manual(values = cbPalette) +
  geom_errorbar(aes(ymin=YMin,ymax=YMax),width=.25) +
  theme(legend.position="None")
```

### Split Condition RT Bar Plot
```{r echo=FALSE, message=FALSE, warning=FALSE}
# lists are collapsed into conditions
d %>%
  filter(Trial_Type == "control" | Trial_Type == "critical") %>%
    mutate(Trial_Type = fct_recode(Trial_Type, "Semantically Unrelated Target" = "control", "Semantically Related Target" = "critical")) %>%
  mutate(talker_identity = ifelse(List=='1_GE' | List == '2_GE','GE','Other')) %>%
  group_by(talker_identity, Trial_Type) %>%
  summarize(MeanRT = mean(Response_Time), CI.Low = ci.low(Response_Time), CI.High = ci.high(Response_Time)) %>%
  mutate(YMin = MeanRT - CI.Low, YMax = MeanRT + CI.High) %>%
  ggplot(aes(x =Trial_Type, y=MeanRT, fill = Trial_Type)) +
  geom_bar(stat="identity")  + 
  xlab("Prime Condition") +
  ylab("Mean RT (ms)") +
  scale_fill_manual(values = cbPalette) +
  geom_errorbar(aes(ymin=YMin,ymax=YMax),width=.25) +
  facet_wrap(~talker_identity) + 
  theme(legend.position="None")
```

### Linear Mixed Model for Northeastern White American Talker Condition
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Trial type is centered around 0
GE_data <- d %>%
  filter(Trial_Type == "control" | Trial_Type == "critical") %>%
  mutate(Trial_Type = as.factor(Trial_Type)) %>%
  mutate(centered_trial_type = as.numeric(Trial_Type) - mean(as.numeric(Trial_Type))) %>%
  mutate(RT = log(Response_Time)) %>%
  mutate(talker_condition = ifelse(List=='1_GE' | List == '2_GE','GE','Other'))
lmer(RT ~ Trial_Type + (1+Trial_Type|workerid) + (1+Trial_Type|Target),data = GE_data)
```

### Linear Mixed Model for Miami Cuban American Talker Condition
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Trial type is centered around 0
GE_data <- d %>%
  filter(Trial_Type == "control" | Trial_Type == "critical") %>%
  mutate(Trial_Type = as.factor(Trial_Type)) %>%
  mutate(centered_trial_type = as.numeric(Trial_Type) - mean(as.numeric(Trial_Type))) %>%
  mutate(RT = log(Response_Time)) %>%
  mutate(talker_condition = ifelse(List=='1_CE' | List == '2_CE','CE','Other'))
lmer(RT ~ Trial_Type + (1+Trial_Type|workerid) + (1+Trial_Type|Target),data = GE_data)
```

### Linear Mixed Model for All Talker Conditions
```{r echo=FALSE, message=FALSE, warning=FALSE}
lmer(RT ~ talker_condition*Trial_Type + (1+Trial_Type|workerid) + (1+Trial_Type+talker_condition|Target),data = new_data)
```